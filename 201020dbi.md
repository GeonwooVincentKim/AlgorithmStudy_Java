## DB 복구(Recovery)
1. controlfile 손실 시 복구
2. redologfile 손실 시 복구
3. datafile 손실 시 복구

## controlfile 손실 시 복구
- [Controlfile다중화](https://sowon-dev.github.io/2020/09/27/200928dbi/) 목적 : 최신 시점으로 복구하기 
- 다중화되어있는 컨트롤파일의 Member 중 하나라도 이상이 있으면 DB작동이 멈춘다.
- 반드시 DB를 종료한 상태에서 남아 있는 Member를 사용해서 복원해야한다.
- 절대 백업파일을 사용하지않는다.
  - 백업파일을 사용해서 백업하는 경우는 오로지 다중화된 controlfile의 Member 모두가 손실된 경우.

## 복구순서
상황 : Controlfile이 다중화되어 있는데 특정 member가 손실된 경우
### 1 DB켜는 중 오류를 발견

```bash
$> startup 

//출력 => nomount는 되지만 mount시 오류발생
```

### 2 DB종료

```bash
$> shut immediate
```

### 3 남아있는 member를 사용해서 손실된 member복구
- 어떤 member가 손상되었는지 log정보 확인하거나 파일위치를 호가인하여 어떤 member가 손실되었는지 확인한다.
  - 파일이 있는데 손상되어있는 경우는 드물다.
  - 보통은 손실되는 경우가 많다.
  
```bash
// 손상되거나 손실된 컨트롤파일 찾기 => fast_recovery_area에 있는 컨트롤파일이 사라졌다.
SQL> show parameter control_files
SQL> !
[oracle@localhost ~]$ cd 
[oracle@localhost ~]$ cd /u01/app/oracle/oradata/ORCL/controlfile/
[oracle@localhost controlfile]$ ls
o1_mf_fwvn95xm_.ctl
[oracle@localhost controlfile]$ cd
[oracle@localhost ~]$ cd /u01/app/oracle/fast_recovery_area/orcl/ORCL/controlfile/
[oracle@localhost controlfile]$ ls
[oracle@localhost controlfile]$ cd /home/oracle/
[oracle@localhost ~]$ ls
200820quizMySol.sql  checkTablespaceNname.sql  consNcol.sql    hr1.sql  ingMe.sql     new_dept.sql     공개      바탕화면  서식
afiedt.buf           cons1.sql                 control103.ctl  hr2.sql  labs_12c      ora12c           다운로드  비디오    음악
backup               cons2.sql                 hr.sql          hr3.sql  load_emp.sql  search_cons.sql  문서      사진
[oracle@localhost ~]$ ^C

// 컨트롤파일 복구
[oracle@localhost controlfile]$ cp o1_mf_fwvn95xm_.ctl /u01/app/oracle/fast_recovery_area/orcl/ORCL/controlfile/o1_mf_fwvn96cd_.ctl

// 컨트롤파일 잘 복사되었는지 확인
[oracle@localhost controlfile]$ cd /u01/app/oracle/fast_recovery_area/orcl/ORCL/controlfile/
[oracle@localhost controlfile]$ ls
o1_mf_fwvn96cd_.ctl
```

### 4 DB 재시작
아까는 mount되지않았던 DB가 정상적으로 start되는 것을 확인할 수 있다.

```bash
$> startup
```


<br><br><br>
## redologfile 손실 시 복구
- redolog file은 group내 member가 하나라도 정상이면 DB는 정상적으로 작동한다.
- 남아있는 member를 사용해서 복구하지않는다 => redologfile은 reuse안됨
  - 기존에 사용했던 redologfile명 재사용 할 수 없다.
- 손실된 member 삭제하고 새로 다중화해야한다.
- [redologfile 다중화](https://sowon-dev.github.io/2020/09/27/200928dbi/#Redologfile%EB%8B%A4%EC%A4%91%ED%99%94) 목적 : DB가 멈추지않고 계속 운영할수있도록  위함

### 1 redolog file확인

```bash
SQL> select group#, members from v$log;

    GROUP#    MEMBERS
---------- ----------
	 1	    3
	 2	    3
	 3	    3
	 4	    3
   
SQL> select group#, member from v$logfile;

    GROUP# MEMBER
---------- --------------------------------------------------
	 3 /u01/app/oracle/oradata/ORCL/onlinelog/o1_mf_3_fwv
	   n9t6z_.log

	 3 /u01/app/oracle/fast_recovery_area/orcl/ORCL/onlin
	   elog/o1_mf_3_fwvn9xf6_.log

	 2 /u01/app/oracle/oradata/ORCL/onlinelog/o1_mf_2_fwv
	   n9ddv_.log

	 2 /u01/app/oracle/fast_recovery_area/orcl/ORCL/onlin
	   elog/o1_mf_2_fwvn9l85_.log

    GROUP# MEMBER
---------- --------------------------------------------------

	 1 /u01/app/oracle/oradata/ORCL/onlinelog/o1_mf_1_fwv
	   n9ddb_.log

	 1 /u01/app/oracle/fast_recovery_area/orcl/ORCL/onlin
	   elog/o1_mf_1_fwvn9o6v_.log

	 4 /u01/app/oracle/oradata/ORCL/onlinelog/redo4a.log
	 4 /u01/app/oracle/fast_recovery_area/orcl/ORCL/onlin
	   elog/redo4b.log


    GROUP# MEMBER
---------- --------------------------------------------------
	 1 /u01/app/oracle/oradata/ORCL/datafile/redo1c.log
	 2 /u01/app/oracle/oradata/ORCL/datafile/redo2c.log
	 3 /u01/app/oracle/oradata/ORCL/datafile/redo3c.log
	 4 /u01/app/oracle/oradata/ORCL/datafile/redo4c.log

12 rows selected.
```

### 2 redolog file복구 명령어

```bash
// redologfile 일부러 삭제
alter database 
drop logfile member '/u01/app/oracle/oradata/ORCL/onlinelog/o1_mf_1_fwvn9ddb_.log'

// rodologfile 복구
alter database 
add logfile member '/u01/app/oracle/oradata/ORCL/onlinelog/o1_mf_1_fwvn9ddb_1.log'
```


<br><br><br>
## datafile 손실 시 복구
- Recovery = Restore + Recover
  - Restore(복원) : 백업 파일로부터 손실된 파일을 디살리는 작업
    - 명령어 : `$> cp `
  - Recover(복구) : datafile만 해당되는 작업
    - 명령어 : `$> cp `
- 케이스 2가지
  1. Non-critical datafile(일반 Datafile) 손실 시
  2. critical datafile(필수 Datafile-system, undo) 손실 시
  
### Non-critical datafile(일반 Datafile) 손실 시 - DB켜는 중에 손실
상황) DB켜는 중에 데이터파일4의 손실 발생했을 때

1. DB mount됨(open안됨)
2. 손실된 datafile을 offline시킴

```bash
$> alter database datafile 4 offline;
```

3. DB오픈 시킴

```bash
$> alter database open;
```

4. restore : 백업으로부터 손실된 datafile만 복원

```bash
$>cp /home/oracle/backup/user01.dbf /u01/.../datafile/user01.dbf
```

5. recover : 복원된 datafile만 복구(부분 DB복구)

```bash
$> recover datafile4;
```

6. 복구가 완료된 datafile online 시킴

```bash
4> alter database datafile 4
```


### Non-critical datafile(일반 Datafile) 손실 시 - DB켜져있는 중에 손실발생
상황) DB켜져있는 중에 데이터파일4의 손실 발생했을 때

1. 손실된 datafile만 offline시킴

```bash
$> alter database datafile 4 offline immediate;
```

2. DB오픈 유지함


4. restore
5. recover
